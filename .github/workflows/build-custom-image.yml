name: Build Custom Image

on:
  push:
    branches: 
     - main
    paths:
      - '*.pkr.hcl'
      - 'src/**'
      - 'pom.xml'

env: 
  PKR_VERSION: "1.8.5" 
  JAVA_VERSION: "19"   

jobs:
  # The job integration-tests runs on the latest Ubuntu environment
  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest

    # Define the postgres service required for the job
    services:
      postgres:
        image: postgres:16
        # Environment variables for the Postgres database, fetched from GitHub Secrets
        env:
          POSTGRES_USER: ${{ secrets.DB_USERNAME }}
          POSTGRES_PASSWORD: ${{ secrets.DB_PASSWORD }}
          POSTGRES_DB: ${{ secrets.DB_NAME }}
        ports:
          - 5432:5432
        # Configure health required checks for the Postgres service
        options: >-
          --health-cmd="pg_isready -U $DB_USERNAME -d $DB_NAME"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      # Step 1: Checkout the repository to get the latest code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 2: Set up Java 19
      - name: Set Up Java v19
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      # Step 3: Set environment variables required for database connection
      - name: Set Environment Variables
        run: |
          echo "DB_HOST=localhost" >> $GITHUB_ENV
          echo "DB_PORT=5432" >> $GITHUB_ENV
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> $GITHUB_ENV
          echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> $GITHUB_ENV
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> $GITHUB_ENV

      # Step 4: Verify that the database is accessible
      - name: Verify Database Connection
        run: |
          sudo apt-get install -y postgresql-client
          PGPASSWORD=${{ env.DB_PASSWORD }} psql -h ${{ env.DB_HOST }} -U ${{ env.DB_USERNAME }} -d ${{ env.DB_NAME }} -c "SELECT 1;"

      # Step 5: Create the test schema if it does not exist
      - name: Create Schema if Not Exists
        run: |
          sudo apt-get install -y postgresql-client
          PGPASSWORD=${{ env.DB_PASSWORD }} psql -h ${{ env.DB_HOST }} -U ${{ env.DB_USERNAME }} -d ${{ env.DB_NAME }} -c "
          DO \$\$
          BEGIN
            IF NOT EXISTS (SELECT 1 FROM pg_catalog.pg_namespace WHERE nspname = 'test') THEN
              CREATE SCHEMA test;
            END IF;
          END;
          \$\$
          "

      # Step 6: Build and run tests
      - name: Build and Run Tests
        run: mvn clean install
     
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v3
        with:
          name: webapp-0.0.1-SNAPSHOT
          path: target/webapp-0.0.1-SNAPSHOT.jar
  
  build-image:
    needs: integration-tests
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v3
      
      - name: Download JAR artifact
        uses: actions/download-artifact@v3
        with:
          name: webapp-0.0.1-SNAPSHOT
          path: packer/
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Configure GCP credentials
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1    
      
      - name: Setup Packer
        uses: hashicorp/setup-packer@v2
        with:
          version: ${{ env.PKR_VERSION }}

      - name: Initialize Packer Template
        run: |
          cd packer
          packer init .
          
      - name: Create Variables File
        run: |
          cat << EOF > packer/variables.pkrvars.hcl
          aws_demo_account_id        = "${{ secrets.AWS_DEMO_ACCOUNT_ID }}"
          gcp_dev_project_id         = "${{ secrets.GCP_DEV_PROJECT_ID }}"
          gcp_demo_project_id        = "${{ secrets.GCP_DEMO_PROJECT_ID }}"
          db_name                    = "${{ secrets.DB_NAME }}"
          db_username                = "${{ secrets.DB_USERNAME }}"
          db_password                = "${{ secrets.DB_PASSWORD }}"
          EOF          
      
      - name: Build Image
        run: |
          cd packer
          packer build -color=false -on-error=abort -var-file=variables.pkrvars.hcl webapp.pkr.hcl
        env:
          PACKER_LOG: 1